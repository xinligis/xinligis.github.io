<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="GIS,地理信息,地理大数据,时空信息,IT技术"><title>ArcGIS自动化部署实践之四：基于PowerShell的AGS Server自动部署1 | 辛立</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/4.2.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.0.0/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">ArcGIS自动化部署实践之四：基于PowerShell的AGS Server自动部署1</h1><a id="logo" href="/.">辛立</a><p class="description">静心耐心专心</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">ArcGIS自动化部署实践之四：基于PowerShell的AGS Server自动部署1</h1><div class="post-meta">Oct 9, 2016<span> | </span><span class="category"><a href="/categories/地理平台/">地理平台</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-自动化部署思路"><span class="toc-number">1.</span> <span class="toc-text">1.自动化部署思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-系统环境准备"><span class="toc-number">2.</span> <span class="toc-text">2.系统环境准备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-AGS-Server安装"><span class="toc-number">3.</span> <span class="toc-text">2.AGS Server安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-AGS-Server授权"><span class="toc-number">4.</span> <span class="toc-text">3.AGS Server授权</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-创建site站点"><span class="toc-number">5.</span> <span class="toc-text">4.创建site站点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-小结"><span class="toc-number">6.</span> <span class="toc-text">5.小结</span></a></li></ol></div></div><div class="post-content"><h2 id="1-自动化部署思路"><a href="#1-自动化部署思路" class="headerlink" title="1.自动化部署思路"></a>1.自动化部署思路</h2><p>单机环境下部署ArcGIS Server主要分为三步：操作系统环境设置、安装和授权ArcGIS Server、创建站点。各步骤中包含的内容如下：</p>
<ol>
<li>系统环境准备</li>
</ol>
<p>包括防火墙设置，.Net环境设置。</p>
<ol>
<li>AGS Server安装</li>
</ol>
<p>包括软件安装、授权，以及重启服务。</p>
<ol>
<li>site站点创建</li>
</ol>
<p>调用REST Admin API创建站点。</p>
<h2 id="2-系统环境准备"><a href="#2-系统环境准备" class="headerlink" title="2.系统环境准备"></a>2.系统环境准备</h2><ol>
<li>检验与安装.NET Framework 4.5.1</li>
</ol>
<p>ArcGIS Server 10.4.X版本需要NET Framework 4.5环境。在安装前需要检查是否已安装该版本的NET Framework，如果没有则需要先安装。Windows Server 2012系统中默认会安装4.5版本的NET Framework，Windows Server 2008上需要手动安装。为了安装方便，可在微软官网上下载离线安装包来安装。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 检查操作系统中是否安装了.NET Framework 4.5</span></div><div class="line"><span class="variable">$netVersion</span> = <span class="built_in">Get-ItemProperty</span> <span class="string">'HKLM:\SOFTWARE\Microsoft\NET Framework Setup\NDP\v4\Client'</span> -Name Version</div><div class="line"></div><div class="line"><span class="variable">$netIdx</span> = <span class="variable">$netVersion</span>.Version.LastIndexOf(<span class="string">"."</span>)</div><div class="line"><span class="variable">$netVersionValue</span> = [Double](<span class="variable">$netVersion</span>.Version.Substring(<span class="number">0</span>,<span class="variable">$netIdx</span>))</div><div class="line"></div><div class="line"><span class="comment"># 版本号不等于4.5时需要新安装</span></div><div class="line"><span class="keyword">if</span>(<span class="variable">$netVersionValue</span> <span class="nomarkup">-ne</span> <span class="number">4.5</span>)&#123;</div><div class="line">    <span class="comment"># Install-WindowsFeature NET-Framework-Core –Source D:\Sources\sxs</span></div><div class="line"></div><div class="line">    <span class="built_in">Start-Process</span> -FilePath <span class="variable">$BinPath</span> -ArgumentList <span class="string">"/q /norestart"</span> -Wait -NoNewWindow</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>关闭操作系统防火墙</li>
</ol>
<p><strong>方法一：根据防火墙开启状态，将开启的防火墙关闭</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 检查防火墙状态。如果防火墙已打开则关闭。</span></div><div class="line"><span class="comment"># 只支持Windows Server 2012和Windows 8及以上版本，其他旧版本需要使用NETSH命令</span></div><div class="line"></div><div class="line"><span class="comment"># 写日志信息</span></div><div class="line"><span class="keyword">function</span> Log-Message([string]<span class="variable">$Msg</span>,[switch]<span class="variable">$PassThru</span>) </div><div class="line">&#123;</div><div class="line">  <span class="string">"[&#123;0&#125;] <span class="variable">$Msg</span>"</span> -f (<span class="built_in">Get-Date</span> -Format <span class="string">"yyyy-dd-MM HH:mm:ss.fffff"</span>) | <span class="built_in">Add-Content</span> <span class="variable">$logFile</span> -Force -ea SilentlyContinue</div><div class="line">  <span class="keyword">if</span> (<span class="variable">$PassThru</span>) &#123;</div><div class="line">    <span class="built_in">Write-Output</span> <span class="variable">$Msg</span></div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">#########################################################################</span></div><div class="line"><span class="comment">## 启动脚本</span></div><div class="line"><span class="comment">#########################################################################</span></div><div class="line"><span class="keyword">try</span>&#123;</div><div class="line">    <span class="variable">$logFile</span>=<span class="string">"c:\agsserver-install.log"</span></div><div class="line"></div><div class="line">    Log-Message <span class="string">"开始检查防火墙状态......"</span> -PassThru</div><div class="line"></div><div class="line">    <span class="variable">$firewallStatus</span> = Get-NetFirewallProfile | <span class="built_in">Select-Object</span> -Property Name,Enabled</div><div class="line">    <span class="keyword">foreach</span> (<span class="variable">$n</span> <span class="keyword">in</span> <span class="variable">$firewallStatus</span>)</div><div class="line">    &#123; </div><div class="line">        Log-Message <span class="string">"信息：当前各个网络环境下的防火设置情况如下："</span></div><div class="line">        Log-Message <span class="string">"信息：网络名：$(<span class="variable">$n</span>.Name)，防火墙状态：$(<span class="variable">$n</span>.Enabled)"</span></div><div class="line">        <span class="keyword">if</span>(<span class="variable">$n</span>.Enabled <span class="nomarkup">-eq</span> <span class="string">"True"</span>)</div><div class="line">        &#123; </div><div class="line">            Log-Message <span class="string">"信息：将关闭该网络'$(<span class="variable">$n</span>.Name)'的防火墙设置"</span></div><div class="line">            Set-NetFirewallProfile -Profile <span class="variable">$n</span>.Name -Enabled False</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Log-Message <span class="string">"防火墙状态设置完成......"</span> -PassThru</div><div class="line">&#125;</div><div class="line"><span class="keyword">catch</span></div><div class="line">&#123;</div><div class="line">    Log-Message <span class="string">"错误：$(<span class="variable">$_</span>.Exception.Message)"</span> -PassThru</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>方法二：简化版本，不管当前防火墙的状态，都直接设置关闭</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 防火墙设置命令在Windows Server 2012和Windows 8之前有所不同，新操作系统使用Set-NetFirewallProfile命令，老版本使用netsh命令。</span></div><div class="line"></div><div class="line"><span class="comment"># 根据操作系统版本信息，选择使用不同的命令</span></div><div class="line"><span class="variable">$osVersion</span> = <span class="built_in">Get-WmiObject</span> -Class Win32_OperatingSystem -ComputerName . | <span class="built_in">Select-Object</span> -Property Caption,Version</div><div class="line"></div><div class="line"><span class="variable">$idx</span> = <span class="variable">$osVersion</span>.Version.LastIndexOf(<span class="string">"."</span>)</div><div class="line"><span class="variable">$osVersionValue</span> = [Double](<span class="variable">$osVersion</span>.Version.Substring(<span class="number">0</span>,<span class="variable">$idx</span>))</div><div class="line"></div><div class="line"><span class="comment"># 判断是否server系统</span></div><div class="line"><span class="keyword">if</span>(<span class="variable">$osVersion</span>.Caption.Contains(<span class="string">"Windows Server"</span>))&#123;</div><div class="line">    <span class="keyword">if</span>(<span class="variable">$osVersionValue</span> <span class="nomarkup">-lt</span> <span class="number">6.3</span>)&#123; </div><div class="line">        netsh advfirewall set allprofiles state off</div><div class="line">    &#125;<span class="keyword">else</span>&#123;</div><div class="line">        Set-NetFirewallProfile -Enabled False</div><div class="line">    &#125;</div><div class="line">&#125;<span class="keyword">else</span>&#123;</div><div class="line">    <span class="keyword">if</span>(<span class="variable">$osVersionValue</span> <span class="nomarkup">-lt</span> <span class="number">8.0</span>)&#123;</div><div class="line">        netsh advfirewall set allprofiles state off</div><div class="line">    &#125;<span class="keyword">else</span>&#123;</div><div class="line">        Set-NetFirewallProfile -Enabled False</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>强密码策略</li>
</ol>
<p>建议按强密码策略设置密码。</p>
<h2 id="2-AGS-Server安装"><a href="#2-AGS-Server安装" class="headerlink" title="2.AGS Server安装"></a>2.AGS Server安装</h2><p>在ArcGIS Server的光盘中包含了Windows版本Server的安装exe程序，该程序其实是一个压缩文件，需要先安装该exe程序，将ArcGIS Server正式的安装程序提取出来。ArcGIS Server支持静默安装，静默安装参数如下：</p>
<table>
<thead>
<tr>
<th>参数名</th>
<th style="text-align:right">参数说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>INSTALLDIR</td>
<td style="text-align:right">ArcGIS Server安装路径</td>
</tr>
<tr>
<td>INSTALLDIR1</td>
<td style="text-align:right">Python的安装路径</td>
<td>、</td>
</tr>
<tr>
<td>USER_NAME</td>
<td style="text-align:right">安装ArcGIS Server的操作系统账号</td>
</tr>
<tr>
<td>PASSWORD</td>
<td style="text-align:right">安装的操作系统账号密码</td>
</tr>
</tbody>
</table>
<p>静默安装示例：<br><code>AGSServer\setup.exe /qb INSTALLDIR=C:\NewServerDir INSTALLDIR1=C:\NewPythonDir USER_NAME=myaccount PASSWORD=my.password</code></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 脚本所用参数列表</span></div><div class="line"><span class="variable">$agsSoftwarePath</span>=<span class="string">"C:\agssoft"</span></div><div class="line"><span class="variable">$agsServerPath</span>= <span class="built_in">Join-Path</span> <span class="variable">$agsSoftwarePath</span> <span class="string">"ArcGISServer1041\Setup.exe"</span></div><div class="line"></div><div class="line"><span class="comment">#AGS SERVER安装参数</span></div><div class="line"><span class="variable">$INSTALLDIR</span>=<span class="string">"C:\arcgis"</span></div><div class="line"><span class="variable">$INSTALLDIR1</span>=<span class="variable">$INSTALLDIR</span></div><div class="line"></div><div class="line"><span class="variable">$USER_NAME</span>=<span class="string">"arcgis"</span></div><div class="line"><span class="variable">$PASSWORD</span>=<span class="string">"ArcGIS1041"</span></div><div class="line"></div><div class="line"><span class="comment"># 1.安装ArcGIS Server</span></div><div class="line">Log-Message <span class="string">"开始安装ArcGIS Server......"</span> -PassThru</div><div class="line">Log-Message <span class="string">"信息：ArcGIS Server安装路径：<span class="variable">$INSTALLDIR</span>"</span> -PassThru</div><div class="line">Log-Message <span class="string">"信息：ArcGIS Server安装账号：<span class="variable">$USER_NAME</span> / <span class="variable">$PASSWORD</span>"</span> -PassThru</div><div class="line">    </div><div class="line"><span class="variable">$serverParams</span> = <span class="string">"/qb INSTALLDIR=<span class="variable">$INSTALLDIR</span> INSTALLDIR1=<span class="variable">$INSTALLDIR1</span> USER_NAME=<span class="variable">$USER_NAME</span> PASSWORD=<span class="variable">$PASSWORD</span>"</span></div><div class="line"><span class="built_in">Start-Process</span> -FilePath <span class="variable">$agsServerPath</span> -ArgumentList <span class="variable">$serverParams</span> -Wait -NoNewWindow</div><div class="line"></div><div class="line">Log-Message <span class="string">"ArcGIS Server安装完成......"</span> -PassThru</div></pre></td></tr></table></figure>
<h2 id="3-AGS-Server授权"><a href="#3-AGS-Server授权" class="headerlink" title="3.AGS Server授权"></a>3.AGS Server授权</h2><p>静默授权示例：<br><code>&lt;系统磁盘驱动器&gt;\Program files\Common files\ArcGIS\bin\SoftwareAuthorization.exe /S /Ver 10.3 /LIF &lt;.prvc授权文件的路径&gt;authorizationfile.prvc</code><br><figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 脚本所用参数列表</span></div><div class="line"><span class="variable">$agsSoftwarePath</span>=<span class="string">"C:\agssoft"</span></div><div class="line"><span class="variable">$agsServerKey</span>= <span class="built_in">Join-Path</span> <span class="variable">$agsSoftwarePath</span> <span class="string">"server.ecp"</span></div><div class="line"></div><div class="line"><span class="comment"># 2.授权ArcGIS Server</span></div><div class="line">    Log-Message <span class="string">"开始授权ArcGIS Server......"</span> -PassThru</div><div class="line">    </div><div class="line">    <span class="variable">$authEXEPath</span>=<span class="built_in">Join-Path</span> <span class="variable">$env:CommonProgramFiles</span> <span class="string">"ArcGIS\bin\SoftwareAuthorization.exe"</span></div><div class="line">    <span class="variable">$authParams</span>=<span class="string">"/s /Ver 10.4 /LIF "</span> + <span class="variable">$agsServerKey</span></div><div class="line">    <span class="built_in">Start-Process</span> -FilePath <span class="variable">$authEXEPath</span> -ArgumentList <span class="variable">$authParams</span> -Wait -NoNewWindow</div><div class="line"></div><div class="line">    Log-Message <span class="string">"ArcGIS Server授权完成......"</span> -PassThru</div><div class="line"></div><div class="line">    <span class="comment"># 3.重启ArcGIS Server服务</span></div><div class="line">    Log-Message <span class="string">"开始重启ArcGIS Server服务......"</span> -PassThru</div><div class="line"></div><div class="line">    <span class="variable">$agsServiceName</span>=<span class="string">"ArcGIS Server"</span></div><div class="line">    <span class="variable">$agsServiceStatus</span> = (<span class="built_in">Get-Service</span> <span class="variable">$agsServiceName</span>).Status</div><div class="line"></div><div class="line">    Log-Message <span class="string">"信息：当前ArcGIS Server服务启动状态：<span class="variable">$agsServiceStatus</span>"</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span>(<span class="variable">$agsServiceStatus</span> <span class="nomarkup">-eq</span> <span class="string">"Running"</span>)&#123;</div><div class="line">        <span class="built_in">Restart-Service</span> -Name <span class="variable">$agsServiceName</span></div><div class="line">    &#125;<span class="keyword">else</span>&#123;</div><div class="line">        <span class="built_in">Start-Service</span> -Name <span class="variable">$agsServiceName</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Log-Message <span class="string">"信息：系统休眠60秒，等待ArcGIS Server系统服务启动完成"</span></div><div class="line"></div><div class="line">    <span class="built_in">Start-Sleep</span> -Seconds <span class="number">60</span></div><div class="line"></div><div class="line">    Log-Message <span class="string">"ArcGIS Server服务重启完成......"</span> -PassThru</div></pre></td></tr></table></figure></p>
<h2 id="4-创建site站点"><a href="#4-创建site站点" class="headerlink" title="4.创建site站点"></a>4.创建site站点</h2><p>站点的创建需要使用ArcGIS REST Admin API，调用CreateSite接口，详细的接口说明见<a href="http://resources.arcgis.com/en/help/arcgis-rest-api/#/Create_Site/02r3000001zs000000/" target="_blank" rel="external">在线帮助</a>。</p>
<ol>
<li>使用HTTPS访问时的证书安全警告</li>
</ol>
<p>ArcGIS Server 10.4.X默认开启了HTTPS，使用的是自签名证书。当使用HTTPS访问Admin网站时，会提示证书安全警告。在powershell中发送HTTPS请求时，可以提供证书信息，也可以忽略证书安全警告，但需要做额外设置。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[System.Net.ServicePointManager]::ServerCertificateValidationCallback = &#123; <span class="literal">$True</span> &#125;</div></pre></td></tr></table></figure>
<ol>
<li>调用Admin API创建站点</li>
</ol>
<p>创建站点需要传入站点管理员信息、配置存储路径、服务目录路径、日志路径等参数，这些参数可以定义在变量中。</p>
<p>示例中测试了两种发送web请求的方法：第一种使用.NET对象；第二种使用powershell封装好的Invoke-RestMethod方法。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">function</span> Create-AGSSite()</div><div class="line">&#123;</div><div class="line">    Log-Message <span class="string">"开始创建ArcGIS Server站点......"</span> -PassThru</div><div class="line"></div><div class="line">    Log-Message <span class="string">"信息：设置站点参数信息"</span></div><div class="line">    Log-Message <span class="string">"信息：ArcGIS Server站点的配置存储路径：<span class="variable">$agsConfigStorePath</span>"</span> -PassThru</div><div class="line">    Log-Message <span class="string">"信息：ArcGIS Server站点的服务目录路径：<span class="variable">$agsServiceDirPath</span>"</span> -PassThru</div><div class="line"></div><div class="line">    <span class="comment"># 10.5之前使用下面的localRepositoryPath参数</span></div><div class="line">    <span class="variable">$localRepositoryPath</span>=<span class="variable">$agsServiceDirPath</span> + <span class="string">"\\local"</span></div><div class="line">    <span class="comment"># 10.5中的localRepositoryPath定义在这里</span></div><div class="line">    <span class="variable">$configStoreConnection</span> = <span class="string">@"</span></div><div class="line">    &#123;</div><div class="line">        "type":"FILESYSTEM",</div><div class="line">        "connectionString": "<span class="variable">$agsConfigStorePath</span>",</div><div class="line">        "localRepositoryPath": "<span class="variable">$localRepositoryPath</span>"   </div><div class="line">    &#125;</div><div class="line">"@</div><div class="line"></div><div class="line">    <span class="variable">$directories</span>=<span class="string">@"</span></div><div class="line">    &#123;</div><div class="line">        "directories": [</div><div class="line">			  &#123;</div><div class="line">			    "name": "arcgiscache",</div><div class="line">			    "physicalPath": "<span class="variable">$agsServiceDirPath</span>\\directories\\arcgiscache",</div><div class="line">			    "directoryType": "CACHE",</div><div class="line">			    "cleanupMode": "NONE",</div><div class="line">			    "maxFileAge": 0,</div><div class="line">			    "description": "Stores tile caches used by map, globe, and image services for rapid performance."</div><div class="line">			  &#125;,</div><div class="line">			  &#123;</div><div class="line">			    "name": "arcgisjobs",</div><div class="line">			    "physicalPath": "<span class="variable">$agsServiceDirPath</span>\\directories\\arcgisjobs",</div><div class="line">			    "directoryType": "JOBS",</div><div class="line">			    "cleanupMode": "TIME_ELAPSED_SINCE_LAST_MODIFIED",</div><div class="line">			    "maxFileAge": 360,</div><div class="line">			    "description": "Stores results and other information from geoprocessing services."</div><div class="line">			  &#125;,</div><div class="line">			  &#123;</div><div class="line">			    "name": "arcgisoutput",</div><div class="line">			    "physicalPath": "<span class="variable">$agsServiceDirPath</span>\\directories\\arcgisoutput",</div><div class="line">			    "directoryType": "OUTPUT",</div><div class="line">			    "cleanupMode": "TIME_ELAPSED_SINCE_LAST_MODIFIED",</div><div class="line">			    "maxFileAge": 10,</div><div class="line">			    "description": "Stores various information generated by services, such as map images."</div><div class="line">			  &#125;,</div><div class="line">			  &#123;</div><div class="line">			    "name": "arcgissystem",</div><div class="line">			    "physicalPath": "<span class="variable">$agsServiceDirPath</span>\\arcgissystem",</div><div class="line">			    "directoryType": "SYSTEM",</div><div class="line">			    "cleanupMode": "NONE",</div><div class="line">			    "maxFileAge": 0,</div><div class="line">			    "description": "Stores directories and files used internally by ArcGIS Server."</div><div class="line">			  &#125;			 </div><div class="line">		]</div><div class="line">    &#125;</div><div class="line">"@</div><div class="line"></div><div class="line">    <span class="variable">$logsSettings</span>=<span class="string">@"</span></div><div class="line">    &#123;</div><div class="line">  		"logLevel": "INFO",</div><div class="line">  		"logDir": "<span class="variable">$agsServiceDirPath</span>\\logs\\",</div><div class="line">  		"maxErrorReportsCount": 10,</div><div class="line">  		"maxLogFileAge": 90</div><div class="line">	&#125;</div><div class="line">"@</div><div class="line"></div><div class="line">    Log-Message <span class="string">"信息：站点参数设置完成"</span> -PassThru</div><div class="line">    Log-Message <span class="string">"信息：参数configStoreConnection：<span class="variable">$configStoreConnection</span>"</span> </div><div class="line">    Log-Message <span class="string">"信息：参数directories：<span class="variable">$directories</span>"</span> </div><div class="line">    Log-Message <span class="string">"信息：参数logsSettings：<span class="variable">$logsSettings</span>"</span> </div><div class="line"></div><div class="line">    <span class="comment"># 使用https访问时，忽略所有证书安全警告</span></div><div class="line">    Ignore-SelfSignedCerts</div><div class="line"></div><div class="line">    <span class="variable">$adminURL</span> = <span class="string">"https://"</span>+<span class="variable">$env:COMPUTERNAME</span>+<span class="string">":6443/arcgis/admin/createNewSite"</span></div><div class="line"></div><div class="line">    Log-Message <span class="string">"信息：站点Admin网站访问网址：<span class="variable">$adminURL</span>"</span> -PassThru</div><div class="line">    Log-Message <span class="string">"信息：开始发送创建站点请求"</span>  -PassThru</div><div class="line"></div><div class="line"><span class="comment">&lt;#    # 方法1：使用Net对象发送Web请求</span></div><div class="line">    # 构造HTTP请求</div><div class="line">    $http_request = New-Object -ComObject Msxml2.XMLHTTP</div><div class="line">    $http_request.open('POST', $adminURL, $false)</div><div class="line">    $http_request.setRequestHeader("Content-type", "application/x-www-form-urlencoded")</div><div class="line"></div><div class="line">    $params = "username=$SITEADMIN&amp;password=$SITEPWD&amp;configStoreConnection=$configStoreConnection&amp;directories=$directories&amp;logsSettings=$logsSettings&amp;runAsync=false&amp;f=json"</div><div class="line">    $http_request.send($params)</div><div class="line"></div><div class="line">    Log-Message "信息：创建站点请求执行完成。"  -PassThru</div><div class="line">    Log-Message "信息：创建站点请求执行完成返回信息：status:$($http_request.status),content:$($http_request.responseText)"</div><div class="line"></div><div class="line">    $responseJson = ConvertFrom-StringData $http_request.responseText</div><div class="line">    # END方法1</div><div class="line">#&gt;</div><div class="line"></div><div class="line">    <span class="comment"># 方法2：使用内建方法发送Web请求</span></div><div class="line">    <span class="variable">$body</span> = @&#123;</div><div class="line">        username=<span class="variable">$SITEADMIN</span>;</div><div class="line">        password=<span class="variable">$SITEPWD</span>;</div><div class="line">        configStoreConnection=<span class="variable">$configStoreConnection</span>;</div><div class="line">        directories=<span class="variable">$directories</span>;</div><div class="line">        logsSettings=<span class="variable">$logsSettings</span>;</div><div class="line">        runAsync=<span class="string">"false"</span>;</div><div class="line">        f=<span class="string">"json"</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="variable">$responseJson</span>=<span class="built_in">Invoke-RestMethod</span> -Uri <span class="variable">$adminURL</span> -Method Post -Body <span class="variable">$body</span></div><div class="line">    </div><div class="line">    Log-Message <span class="string">"信息：创建站点请求执行完成。"</span>  -PassThru</div><div class="line">    <span class="comment"># END方法2</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span>(<span class="variable">$responseJson</span>.status <span class="nomarkup">-eq</span> <span class="string">"success"</span>)&#123;</div><div class="line">        Log-Message <span class="string">"信息：站点创建完成。"</span> -PassThru</div><div class="line"></div><div class="line">        <span class="built_in">Start-Sleep</span> -Seconds <span class="number">60</span></div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="number">1</span></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment"># messages是Object[]数组类型，转单行字符串</span></div><div class="line">    <span class="variable">$responseMsgs</span>=<span class="variable">$responseJson</span>.messages | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.toString()&#125;</div><div class="line">    <span class="variable">$responseShortMsgs</span>=[string]::Join(<span class="string">""</span>,<span class="variable">$responseMsgs</span>)</div><div class="line">    Log-Message <span class="string">"错误：站点创建失败。错误信息：<span class="variable">$responseShortMsgs</span>"</span> -PassThru</div><div class="line">    Log-Message <span class="string">"错误：站点创建执行返回信息：status=$(<span class="variable">$responseJson</span>.status),messages=<span class="variable">$responseShortMsgs</span>,code=$(<span class="variable">$responseJson</span>.code)"</span></div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="5-小结"><a href="#5-小结" class="headerlink" title="5.小结"></a>5.小结</h2><p>断断续续的花了很长时间，终于完成了ArcGIS Server的自动化安装的脚本编写，但这还只是万里长征走出了第一步。我的终极想法是使用脚本实现单机环境下Portal for ArcGIS的自动部署。想法的最初来源是，在安装了无数次Portal试用环境之后，终于发现了无聊的重复，是时候让机器来干点这种重复的活了。</p>
<p>上面的脚本编写测试的环境是：干净的Windows Server 2012 R2、ArcGIS Server 10.4.1。还没来得及在其他环境下做严格测试。</p>
<p>完整的ArcGIS Server自动部署脚本请<a href="https://github.com/xinligis/ArcGISAutoMate" target="_blank" rel="external">下载</a>。</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://xinligis.github.io/2016/10/09/20161009-AGS10.4.x-ArcGIS自动化部署实践之四：基于powershell的AGS Server自动部署1/" data-id="ciu3sfy8k000at0v8l6vy5vzl" class="article-share-link">分享到</a><div class="tags"><a href="/tags/ArcGIS-PowerShell-自动化部署/">ArcGIS,PowerShell,自动化部署</a></div><div class="post-nav"><a href="/2016/09/08/20160908-AGS10.4.x-ArcGIS自动化部署实践之一：Chef环境搭建与演练/" class="next">ArcGIS自动化部署实践之一：Chef环境搭建与演练</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/地理平台/">地理平台</a><span class="category-list-count">5</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/10/09/20161009-AGS10.4.x-ArcGIS自动化部署实践之四：基于powershell的AGS Server自动部署1/">ArcGIS自动化部署实践之四：基于PowerShell的AGS Server自动部署1</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/08/20160908-AGS10.4.x-ArcGIS自动化部署实践之一：Chef环境搭建与演练/">ArcGIS自动化部署实践之一：Chef环境搭建与演练</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/08/20160909-AGS10.4.x-ArcGIS自动化部署实践之二：Chef生产环境测试/">ArcGIS自动化部署实践之二：Chef生产环境测试</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/08/20160919-AGS10.4.x-ArcGIS自动化部署实践之三：Powershell命令入门/">ArcGIS自动化部署实践之三：PowerShell命令入门</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/05/20160905-Portal10.4.x-部署常见问题处理/">Portal for ArcGIS部署常见问题处理</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://xinligis.github.io/" title="GitHub" target="_blank">GitHub</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">辛立.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
  });
</script><script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML" async></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>