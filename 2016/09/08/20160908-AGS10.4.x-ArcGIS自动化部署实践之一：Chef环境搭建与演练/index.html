<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="GIS,地理信息,地理大数据,时空信息,IT技术"><title>ArcGIS自动化部署实践之一：Chef环境搭建与演练 | 辛立</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/4.2.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.0.0/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">ArcGIS自动化部署实践之一：Chef环境搭建与演练</h1><a id="logo" href="/.">辛立</a><p class="description">静心耐心专心</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">ArcGIS自动化部署实践之一：Chef环境搭建与演练</h1><div class="post-meta">Sep 8, 2016<span> | </span><span class="category"><a href="/categories/地理平台/">地理平台</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-Chef概述"><span class="toc-number">1.</span> <span class="toc-text">1.Chef概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Chef环境准备"><span class="toc-number">2.</span> <span class="toc-text">2.Chef环境准备</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-软件"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 软件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-系统要求"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 系统要求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-Chef-DK安装"><span class="toc-number">2.3.</span> <span class="toc-text">2.3 Chef DK安装</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-Chef演练一：Resource资源的使用"><span class="toc-number">3.</span> <span class="toc-text">3.Chef演练一：Resource资源的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-创建工作目录"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 创建工作目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-创建INI文件测试"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 创建INI文件测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-小结"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 小结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-Chef演练二：安装软件和启动服务"><span class="toc-number">4.</span> <span class="toc-text">4.Chef演练二：安装软件和启动服务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-安装IIS"><span class="toc-number">4.1.</span> <span class="toc-text">4.1 安装IIS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-启动3W服务"><span class="toc-number">4.2.</span> <span class="toc-text">4.2 启动3W服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-定义web页面"><span class="toc-number">4.3.</span> <span class="toc-text">4.3 定义web页面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-测试Web页面"><span class="toc-number">4.4.</span> <span class="toc-text">4.3 测试Web页面</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-Chef演练三：cookbook使用"><span class="toc-number">5.</span> <span class="toc-text">5.Chef演练三：cookbook使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-Cookbook概述"><span class="toc-number">5.1.</span> <span class="toc-text">5.1 Cookbook概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-创建cookbook"><span class="toc-number">5.2.</span> <span class="toc-text">5.2 创建cookbook</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-创建template"><span class="toc-number">5.3.</span> <span class="toc-text">5.3 创建template</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-更新recipe内容"><span class="toc-number">5.4.</span> <span class="toc-text">5.4 更新recipe内容</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5-执行cookbook"><span class="toc-number">5.5.</span> <span class="toc-text">5.5 执行cookbook</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考资料"><span class="toc-number">6.</span> <span class="toc-text">参考资料</span></a></li></ol></div></div><div class="post-content"><h2 id="1-Chef概述"><a href="#1-Chef概述" class="headerlink" title="1.Chef概述"></a>1.Chef概述</h2><p>Chef是一款自动化服务器配置管理工具，可以对所管理的对象实行自动化配置，如系统管理，安装软件等。Chef由三大组件组成：<code>Chef Server</code>、<code>Chef Workstation</code>和<code>Chef Node</code>。</p>
<p><img src="http://od0gjyiqq.bkt.clouddn.com/20160908-chef-components-20161010.png" alt="Chef环境"></p>
<p><strong>Chef Server：</strong> 核心资源服务器，维护配置脚本，与Nodes机器交互。</p>
<p><strong>Chef Workstation：</strong> Chef操作平台，提供与Chef server交互的接口。我们在Workstation上创建定义Cookbook，并将Cookbook上传到Chef Server上以保证被管机器能从Chef Server上取得最新的配置指令。</p>
<p><strong>Chef Node：</strong> 安装了Chef Client并注册了的管理节点。</p>
<h2 id="2-Chef环境准备"><a href="#2-Chef环境准备" class="headerlink" title="2.Chef环境准备"></a>2.Chef环境准备</h2><h3 id="2-1-软件"><a href="#2-1-软件" class="headerlink" title="2.1 软件"></a>2.1 软件</h3><ul>
<li>Windows Server 2012 R2</li>
<li>Chef Development Kit 0.17.17<h3 id="2-2-系统要求"><a href="#2-2-系统要求" class="headerlink" title="2.2 系统要求"></a>2.2 系统要求</h3></li>
<li>设置固定IP</li>
<li>开放80和443端口</li>
<li>打开RDP和WinRM</li>
</ul>
<blockquote>
<p><strong>附：配置Windows开启WinRM服务</strong></p>
<p>WinRM服务是Windows的远程管理服务，简单理解为Windows版的SSH。在Windows server 2012 R2操作系统中，WinRM服务默认是关闭的，需要启用它。首先需要修改组策略。</p>
<ol>
<li>在<code>cmd</code>中输入<code>gpedit.msc</code>打开组策略编辑器，选择<code>计算机配置-&gt;管理模板-&gt;Windows组件-&gt;Windows远程管理(WinRM)-&gt;WinRM服务</code>中，选择<code>允许通过WinRM进行远程服务器管理</code>，把该策略选为启用，并修改IPv4和IPv6过滤器为*。<br><img src="http://od0gjyiqq.bkt.clouddn.com/20160908-chef-winrm-20161010.png" alt="WinRM策略修改"></li>
</ol>
<p><strong>建议配置基本身份验证、未加密通信、HTTP和HTTPS监听。</strong></p>
<ol>
<li>在控制面板中选择windows防火墙，单击例外选项卡，选择Windows 远程管理复选框。如果看不到该复选框，请单击添加程序以添加 Windows 远程管理。</li>
<li>检查WinRM是否启动：<code>winrm e winrm/config/listener</code></li>
<li>配置WinRM：<code>winrm quickconfig</code><blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;</span> <span class="symbol">C:</span>\Users\Administrator&gt;winrm quickconfig</div><div class="line"><span class="meta">&gt;&gt;</span> 已在此计算机上运行 WinRM 服务。</div><div class="line"><span class="meta">&gt;&gt;</span> WinRM 没有设置成为了管理此计算机而允许对其进行远程访问。</div><div class="line"><span class="meta">&gt;&gt;</span> 必须进行以下更改:</div><div class="line">&gt;&gt; </div><div class="line">&gt;&gt; 配置 LocalAccountTokenFilterPolicy 以远程向本地用户授予管理权限。</div><div class="line"><span class="meta">&gt;&gt;</span> </div><div class="line"><span class="meta">&gt;&gt;</span> 执行这些更改吗[y/n]? y</div><div class="line"><span class="meta">&gt;&gt;</span> </div><div class="line"><span class="meta">&gt;&gt;</span> WinRM 已经进行了更新，以用于远程管理。</div><div class="line"><span class="meta">&gt;&gt;</span> </div><div class="line"><span class="meta">&gt;&gt;</span> 已配置 LocalAccountTokenFilterPolicy 以远程向本地用户授予管理权限。</div><div class="line">&gt;</div></pre></td></tr></table></figure>
</blockquote>
</li>
</ol>
</blockquote>
<h3 id="2-3-Chef-DK安装"><a href="#2-3-Chef-DK安装" class="headerlink" title="2.3 Chef DK安装"></a>2.3 Chef DK安装</h3><p>默认安装即可。</p>
<h2 id="3-Chef演练一：Resource资源的使用"><a href="#3-Chef演练一：Resource资源的使用" class="headerlink" title="3.Chef演练一：Resource资源的使用"></a>3.Chef演练一：Resource资源的使用</h2><p><strong>Chef resource：</strong> 定义系统资源，如文件，模板，包，文件夹等。</p>
<p><strong>chef recipe：</strong> 执行任务的地方，是一个文本文件，包含了各种resource资源。</p>
<h3 id="3-1-创建工作目录"><a href="#3-1-创建工作目录" class="headerlink" title="3.1 创建工作目录"></a>3.1 创建工作目录</h3><p>打开PowerShell，使用命令创建chef-repo文件夹。</p>
<p><code>mkdir chef-repo</code></p>
<h3 id="3-2-创建INI文件测试"><a href="#3-2-创建INI文件测试" class="headerlink" title="3.2 创建INI文件测试"></a>3.2 创建INI文件测试</h3><p>在chef-repo目录下创建<strong>hello.rb</strong>文件，并输入如下的内容：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">file <span class="string">'C:\Users\Administrator\chef-repo\settings.ini'</span> <span class="keyword">do</span></div><div class="line">  content <span class="string">'greeting=hello world'</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p>
<p><strong>第一次执行<code>chef-client</code>命令</strong></p>
<p>在命令行中输入<code>chef-client</code>命令执行。默认情况下，chef-client命令会从chef server上下载chef代码执行，这里使用的本地模式，即执行本地的chef代码。</p>
<p><code>chef-client --local-mode hello.rb</code></p>
<p>执行效果如下：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">PS <span class="string">C:</span>\automate\chef-repo&gt; chef-client --local-mode hello.rb</div><div class="line">[<span class="number">2016</span><span class="number">-09</span><span class="number">-09</span><span class="string">T11:</span><span class="number">03</span>:<span class="number">25</span>+<span class="number">08</span>:<span class="number">00</span>] <span class="string">WARN:</span> No config file found or specified on command line, using command line options.</div><div class="line">[<span class="number">2016</span><span class="number">-09</span><span class="number">-09</span><span class="string">T11:</span><span class="number">03</span>:<span class="number">25</span>+<span class="number">08</span>:<span class="number">00</span>] <span class="string">WARN:</span> No cookbooks directory found at or above current directory.  Assuming <span class="string">C:</span><span class="regexp">/automate/</span>chef</div><div class="line">-repo.</div><div class="line">Starting Chef Client, version <span class="number">12.13</span><span class="number">.37</span></div><div class="line">resolving cookbooks <span class="keyword">for</span> run <span class="string">list:</span> []</div><div class="line">Synchronizing <span class="string">Cookbooks:</span></div><div class="line">Installing Cookbook <span class="string">Gems:</span></div><div class="line">Compiling Cookbooks...</div><div class="line">[<span class="number">2016</span><span class="number">-09</span><span class="number">-09</span><span class="string">T11:</span><span class="number">03</span>:<span class="number">46</span>+<span class="number">08</span>:<span class="number">00</span>] <span class="string">WARN:</span> Node WIN-JQ088CD77EE has an empty run list.</div><div class="line">Converging <span class="number">1</span> resources</div><div class="line"><span class="string">Recipe:</span> <span class="meta">@recipe</span><span class="string">_files:</span>:<span class="string">C:</span><span class="regexp">/automate/</span>chef-repo/hello.rb</div><div class="line">  * file[<span class="string">c:</span>\automate\chef-repo\settings.ini] action create</div><div class="line">    - create <span class="keyword">new</span> file <span class="string">c:</span>\automate\chef-repo\settings.ini</div><div class="line">    - update content <span class="keyword">in</span> file <span class="string">c:</span>\automate\chef-repo\settings.ini from none to <span class="number">6823</span>fa</div><div class="line">    --- <span class="string">c:</span>\automate\chef-repo\settings.ini      <span class="number">2016</span><span class="number">-09</span><span class="number">-09</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">46.000000000</span> +<span class="number">0800</span></div><div class="line">    +++ <span class="string">c:</span>\automate\chef-repo/chef-settings.ini20160909<span class="number">-2620</span><span class="number">-15</span>o8onp    <span class="number">2016</span><span class="number">-09</span><span class="number">-09</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">46.000000000</span> +<span class="number">0800</span></div><div class="line">    @@ <span class="number">-1</span> +<span class="number">1</span>,<span class="number">2</span> @@</div><div class="line">    +greeting=hello world</div><div class="line"></div><div class="line">Running <span class="string">handlers:</span></div><div class="line">Running handlers complete</div><div class="line">Chef Client finished, <span class="number">1</span>/<span class="number">1</span> resources updated <span class="keyword">in</span> <span class="number">20</span> seconds</div></pre></td></tr></table></figure></p>
<p>执行完成会在目录下生成settings.ini文件，查看该文件内容：<br><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">PS <span class="keyword">C</span>:\automate\chef-repo&gt; <span class="keyword">Get</span>-Content settings.ini</div><div class="line">greeting=hello world</div></pre></td></tr></table></figure></p>
<p><strong>再次执行<code>chef-client</code>命令</strong></p>
<p><code>chef-client --local-mode hello.rb</code></p>
<p>执行效果如下：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">PS <span class="attribute">C</span>:\automate\chef-repo&gt; chef-client --local-mode hello.rb</div><div class="line">[<span class="number">2016</span><span class="attribute">-09-09T11</span>:<span class="number">21</span>:<span class="number">56</span>+<span class="number">08</span>:<span class="number">00</span>] <span class="attribute">WARN</span>: No config file found or specified on command line, using command line options.</div><div class="line">[<span class="number">2016</span><span class="attribute">-09-09T11</span>:<span class="number">21</span>:<span class="number">56</span>+<span class="number">08</span>:<span class="number">00</span>] <span class="attribute">WARN</span>: No cookbooks directory found at or above current directory.  Assuming <span class="attribute">C</span>:/automate/chef</div><div class="line">-repo.</div><div class="line">Starting Chef Client, version <span class="number">12.13</span>.<span class="number">37</span></div><div class="line">resolving cookbooks for run <span class="attribute">list</span>: []</div><div class="line">Synchronizing <span class="attribute">Cookbooks</span>:</div><div class="line">Installing Cookbook <span class="attribute">Gems</span>:</div><div class="line">Compiling Cookbooks...</div><div class="line">[<span class="number">2016</span><span class="attribute">-09-09T11</span>:<span class="number">22</span>:<span class="number">10</span>+<span class="number">08</span>:<span class="number">00</span>] <span class="attribute">WARN</span>: Node WIN-JQ088CD77EE has an empty run list.</div><div class="line">Converging <span class="number">1</span> resources</div><div class="line"><span class="attribute">Recipe</span>: <span class="variable">@recipe_files</span>::<span class="attribute">C</span>:/automate/chef-repo/hello.rb</div><div class="line">  * file[<span class="attribute">c</span>:\automate\chef-repo\settings.ini] action create (up to date)</div><div class="line"></div><div class="line">Running <span class="attribute">handlers</span>:</div><div class="line">Running handlers complete</div><div class="line">Chef Client finished, <span class="number">0</span>/<span class="number">1</span> resources updated in <span class="number">14</span> seconds</div></pre></td></tr></table></figure>
<p>chef-client执行时会检查当前配置状态，如果没有变化则不会重复执行。</p>
<p><strong>修改INI内容，测试配置更新</strong></p>
<p>修改hello.rb文件中的输出内容，如：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">file <span class="string">'c:\automate\chef-repo\settings.ini'</span> <span class="keyword">do</span></div><div class="line">	content <span class="string">'greeting=hello world，ruby！'</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p>
<p>再执行<code>chef-client</code>命令：<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">PS C:\automate\chef-repo&gt; chef-client --local-<span class="keyword">mode</span> hello.rb</div><div class="line">[<span class="number">2016</span>-<span class="number">09</span>-<span class="number">09</span>T11:<span class="number">29</span>:<span class="number">37</span>+<span class="number">08</span>:<span class="number">00</span>] WARN: No config <span class="keyword">file</span> found <span class="built_in">or</span> specified <span class="keyword">on</span> <span class="keyword">command</span> <span class="built_in">line</span>, using <span class="keyword">command</span> <span class="built_in">line</span> <span class="keyword">options</span>.</div><div class="line">[<span class="number">2016</span>-<span class="number">09</span>-<span class="number">09</span>T11:<span class="number">29</span>:<span class="number">37</span>+<span class="number">08</span>:<span class="number">00</span>] WARN: No cookbooks directory found at <span class="built_in">or</span> above current directory.  Assuming C:/automate/chef</div><div class="line">-repo.</div><div class="line">Starting Chef Client, <span class="keyword">version</span> <span class="number">12.13</span>.<span class="number">37</span></div><div class="line">resolving cookbooks <span class="keyword">for</span> run lis<span class="variable">t:</span> []</div><div class="line">Synchronizing Cookbook<span class="variable">s:</span></div><div class="line">Installing Cookbook Gem<span class="variable">s:</span></div><div class="line">Compiling Cookbooks...</div><div class="line">[<span class="number">2016</span>-<span class="number">09</span>-<span class="number">09</span>T11:<span class="number">29</span>:<span class="number">50</span>+<span class="number">08</span>:<span class="number">00</span>] WARN: Node WIN-JQ088CD77EE <span class="built_in">has</span> <span class="keyword">an</span> <span class="built_in">empty</span> run <span class="keyword">list</span>.</div><div class="line">Converging <span class="number">1</span> resources</div><div class="line">Recipe: @recipe_file<span class="variable">s:</span>:C:/automate/chef-repo/hello.rb</div><div class="line">  * <span class="keyword">file</span>[<span class="keyword">c</span>:\automate\chef-repo\settings.ini] action create</div><div class="line">    - <span class="keyword">update</span> content in <span class="keyword">file</span> <span class="keyword">c</span>:\automate\chef-repo\settings.ini from <span class="number">6823</span>fa <span class="keyword">to</span> a79429</div><div class="line">    --- <span class="keyword">c</span>:\automate\chef-repo\settings.ini      <span class="number">2016</span>-<span class="number">09</span>-<span class="number">09</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">46.000000000</span> +<span class="number">0800</span></div><div class="line">    +++ <span class="keyword">c</span>:\automate\chef-repo/chef-settings.ini20160909-<span class="number">2424</span>-<span class="number">5</span>cqiwi     <span class="number">2016</span>-<span class="number">09</span>-<span class="number">09</span> <span class="number">11</span>:<span class="number">29</span>:<span class="number">50.000000000</span> +<span class="number">0800</span></div><div class="line">    @@ -<span class="number">1</span>,<span class="number">2</span> +<span class="number">1</span>,<span class="number">2</span> @@</div><div class="line">    -greeting=hello world</div><div class="line">    +greeting=hello world，<span class="keyword">ruby</span>！</div><div class="line"></div><div class="line">Running handler<span class="variable">s:</span></div><div class="line">Running handlers <span class="built_in">complete</span></div><div class="line">Chef Client finished, <span class="number">1</span>/<span class="number">1</span> resources updated in <span class="number">12</span> seconds</div></pre></td></tr></table></figure></p>
<p>从上面执行结果可以看到chef会更新执行。</p>
<p><strong>删除INI文件测试</strong></p>
<p>在工作目录下创建<strong>goodbye.rb</strong>文件，文件内容如下：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">file <span class="string">'c:\automate\chef-repo\settings.ini'</span> <span class="keyword">do</span></div><div class="line">	action <span class="symbol">:delete</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p>
<p>执行<code>chef-client</code>后，可查看settings.ini文件已经删除。</p>
<h3 id="3-3-小结"><a href="#3-3-小结" class="headerlink" title="3.3 小结"></a>3.3 小结</h3><ol>
<li>chef提供了多种resource供操作，resource包含了系统状态描述和动作，如上例中的file，以及创建和删除操作。</li>
<li>recipe组织资源，定义资源执行顺序。如上例中的hello.rb文件和goodbye.rb文件。</li>
</ol>
<h2 id="4-Chef演练二：安装软件和启动服务"><a href="#4-Chef演练二：安装软件和启动服务" class="headerlink" title="4.Chef演练二：安装软件和启动服务"></a>4.Chef演练二：安装软件和启动服务</h2><h3 id="4-1-安装IIS"><a href="#4-1-安装IIS" class="headerlink" title="4.1 安装IIS"></a>4.1 安装IIS</h3><p>以安装IIS为例，新建<code>webserver.rb</code>文件，文件内容如下：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">powershell_script <span class="string">'Install IIS'</span> <span class="keyword">do</span></div><div class="line">	code <span class="string">'Add-WindowsFeature Web-Server'</span></div><div class="line">	guard_interpreter <span class="symbol">:powershell_script</span></div><div class="line">	not_if <span class="string">"(Get-WindowsFeature -Name Web-Server).Installed"</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p>
<p><strong>第一次执行<code>chef-client</code>命令</strong></p>
<p><code>chef-client --local-mode webserver.rb</code></p>
<p>执行效果：<br><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">PS <span class="attribute">C</span>:\automate\chef-repo&gt; chef-client --local-mode webserver.rb</div><div class="line">[<span class="number">2016</span><span class="attribute">-09-09T14</span>:<span class="number">25</span>:<span class="number">10</span>+<span class="number">08</span>:<span class="number">00</span>] <span class="attribute">WARN</span>: No config file found or specified on command line, using command line options.</div><div class="line">[<span class="number">2016</span><span class="attribute">-09-09T14</span>:<span class="number">25</span>:<span class="number">10</span>+<span class="number">08</span>:<span class="number">00</span>] <span class="attribute">WARN</span>: No cookbooks directory found at or above current directory.  Assuming <span class="attribute">C</span>:/automate/chef</div><div class="line">-repo.</div><div class="line">Starting Chef Client, version <span class="number">12.13</span>.<span class="number">37</span></div><div class="line">resolving cookbooks for run <span class="attribute">list</span>: []</div><div class="line">Synchronizing <span class="attribute">Cookbooks</span>:</div><div class="line">Installing Cookbook <span class="attribute">Gems</span>:</div><div class="line">Compiling Cookbooks...</div><div class="line">[<span class="number">2016</span><span class="attribute">-09-09T14</span>:<span class="number">25</span>:<span class="number">23</span>+<span class="number">08</span>:<span class="number">00</span>] <span class="attribute">WARN</span>: Node WIN-JQ088CD77EE has an empty run list.</div><div class="line">Converging <span class="number">1</span> resources</div><div class="line"><span class="attribute">Recipe</span>: <span class="variable">@recipe_files</span>::<span class="attribute">C</span>:/automate/chef-repo/webserver.rb</div><div class="line">  * powershell_script[Install IIS] action run</div><div class="line">    - execute <span class="string">"C:\Windows\system32\WindowsPowerShell\v1.0\powershell.exe"</span> -NoLogo -NonInteractive -NoProfile -ExecutionP</div><div class="line">olicy Bypass -InputFormat None -File <span class="string">"C:/Users/ADMINI~1/AppData/Local/Temp/1/chef-script20160909-1844-1jn8f49.ps1"</span></div><div class="line"></div><div class="line">Running <span class="attribute">handlers</span>:</div><div class="line">Running handlers complete</div><div class="line">Chef Client finished, <span class="number">1</span>/<span class="number">1</span> resources updated in <span class="number">01</span> minutes <span class="number">12</span> seconds</div></pre></td></tr></table></figure></p>
<p><strong>第二次执行<code>chef-client</code>命令</strong></p>
<p>执行效果：<br><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">PS <span class="attribute">C</span>:\automate\chef-repo&gt; chef-client --local-mode webserver.rb</div><div class="line">[<span class="number">2016</span><span class="attribute">-09-09T14</span>:<span class="number">31</span>:<span class="number">32</span>+<span class="number">08</span>:<span class="number">00</span>] <span class="attribute">WARN</span>: No config file found or specified on command line, using command line options.</div><div class="line">[<span class="number">2016</span><span class="attribute">-09-09T14</span>:<span class="number">31</span>:<span class="number">32</span>+<span class="number">08</span>:<span class="number">00</span>] <span class="attribute">WARN</span>: No cookbooks directory found at or above current directory.  Assuming <span class="attribute">C</span>:/automate/chef</div><div class="line">-repo.</div><div class="line">Starting Chef Client, version <span class="number">12.13</span>.<span class="number">37</span></div><div class="line">resolving cookbooks for run <span class="attribute">list</span>: []</div><div class="line">Synchronizing <span class="attribute">Cookbooks</span>:</div><div class="line">Installing Cookbook <span class="attribute">Gems</span>:</div><div class="line">Compiling Cookbooks...</div><div class="line">[<span class="number">2016</span><span class="attribute">-09-09T14</span>:<span class="number">31</span>:<span class="number">45</span>+<span class="number">08</span>:<span class="number">00</span>] <span class="attribute">WARN</span>: Node WIN-JQ088CD77EE has an empty run list.</div><div class="line">Converging <span class="number">1</span> resources</div><div class="line"><span class="attribute">Recipe</span>: <span class="variable">@recipe_files</span>::<span class="attribute">C</span>:/automate/chef-repo/webserver.rb</div><div class="line">  * powershell_script[Install IIS] action run (skipped due to not_if)</div><div class="line"></div><div class="line">Running <span class="attribute">handlers</span>:</div><div class="line">Running handlers complete</div><div class="line">Chef Client finished, <span class="number">0</span>/<span class="number">1</span> resources updated in <span class="number">13</span> seconds</div></pre></td></tr></table></figure></p>
<p>从执行结果可以看出，由于有not_if语句，chef不会重新安装IIS。</p>
<h3 id="4-2-启动3W服务"><a href="#4-2-启动3W服务" class="headerlink" title="4.2 启动3W服务"></a>4.2 启动3W服务</h3><p>修改webserver.rb文件，增加启动3W的服务：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">powershell_script <span class="string">'Install IIS'</span> <span class="keyword">do</span></div><div class="line">	code <span class="string">'Add-WindowsFeature Web-Server'</span></div><div class="line">	guard_interpreter <span class="symbol">:powershell_script</span></div><div class="line">	not_if <span class="string">"(Get-WindowsFeature -Name Web-Server).Installed"</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line">service <span class="string">'w3svc'</span> <span class="keyword">do</span></div><div class="line">	action [<span class="symbol">:enable</span>, <span class="symbol">:start</span>]</div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p>
<p>执行<code>chef-client</code>命令：<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">PS C:\automate\chef-repo&gt; chef-client --local-<span class="keyword">mode</span> webserver.rb</div><div class="line">[<span class="number">2016</span>-<span class="number">09</span>-<span class="number">09</span>T14:<span class="number">34</span>:<span class="number">46</span>+<span class="number">08</span>:<span class="number">00</span>] WARN: No config <span class="keyword">file</span> found <span class="built_in">or</span> specified <span class="keyword">on</span> <span class="keyword">command</span> <span class="built_in">line</span>, using <span class="keyword">command</span> <span class="built_in">line</span> <span class="keyword">options</span>.</div><div class="line">[<span class="number">2016</span>-<span class="number">09</span>-<span class="number">09</span>T14:<span class="number">34</span>:<span class="number">46</span>+<span class="number">08</span>:<span class="number">00</span>] WARN: No cookbooks directory found at <span class="built_in">or</span> above current directory.  Assuming C:/automate/chef</div><div class="line">-repo.</div><div class="line">Starting Chef Client, <span class="keyword">version</span> <span class="number">12.13</span>.<span class="number">37</span></div><div class="line">resolving cookbooks <span class="keyword">for</span> run lis<span class="variable">t:</span> []</div><div class="line">Synchronizing Cookbook<span class="variable">s:</span></div><div class="line">Installing Cookbook Gem<span class="variable">s:</span></div><div class="line">Compiling Cookbooks...</div><div class="line">[<span class="number">2016</span>-<span class="number">09</span>-<span class="number">09</span>T14:<span class="number">34</span>:<span class="number">59</span>+<span class="number">08</span>:<span class="number">00</span>] WARN: Node WIN-JQ088CD77EE <span class="built_in">has</span> <span class="keyword">an</span> <span class="built_in">empty</span> run <span class="keyword">list</span>.</div><div class="line">Converging <span class="number">2</span> resources</div><div class="line">Recipe: @recipe_file<span class="variable">s:</span>:C:/automate/chef-repo/webserver.rb</div><div class="line">  * powershell_script[Install IIS] action run (skipped due <span class="keyword">to</span> not_if)</div><div class="line">  * windows_service[w3svc] action enable (<span class="keyword">up</span> <span class="keyword">to</span> date)</div><div class="line">  * windows_service[w3svc] action start (<span class="keyword">up</span> <span class="keyword">to</span> date)</div><div class="line"></div><div class="line">Running handler<span class="variable">s:</span></div><div class="line">Running handlers <span class="built_in">complete</span></div><div class="line">Chef Client finished, <span class="number">0</span>/<span class="number">3</span> resources updated in <span class="number">13</span> seconds</div></pre></td></tr></table></figure></p>
<h3 id="4-3-定义web页面"><a href="#4-3-定义web页面" class="headerlink" title="4.3 定义web页面"></a>4.3 定义web页面</h3><p>继续修改webserver.rb文件：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">powershell_script <span class="string">'Install IIS'</span> <span class="keyword">do</span></div><div class="line">	code <span class="string">'Add-WindowsFeature Web-Server'</span></div><div class="line">	guard_interpreter <span class="symbol">:powershell_script</span></div><div class="line">	not_if <span class="string">"(Get-WindowsFeature -Name Web-Server).Installed"</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line">service <span class="string">'w3svc'</span> <span class="keyword">do</span></div><div class="line">	action [<span class="symbol">:enable</span>, <span class="symbol">:start</span>]</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line">file <span class="string">'C:\inetpub\wwwroot\default.htm'</span> <span class="keyword">do</span></div><div class="line">	content <span class="string">'&lt;html&gt;</span></div><div class="line">	&lt;body&gt;</div><div class="line">		&lt;h1&gt;hello, chef.&lt;/h1&gt;</div><div class="line">	&lt;/body&gt;</div><div class="line">	&lt;/html&gt;'</div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p>
<p>执行<code>chef-client</code>命令：<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">PS C:\automate\chef-repo&gt; chef-client --local-<span class="keyword">mode</span> webserver.rb</div><div class="line">[<span class="number">2016</span>-<span class="number">09</span>-<span class="number">09</span>T14:<span class="number">40</span>:<span class="number">56</span>+<span class="number">08</span>:<span class="number">00</span>] WARN: No config <span class="keyword">file</span> found <span class="built_in">or</span> specified <span class="keyword">on</span> <span class="keyword">command</span> <span class="built_in">line</span>, using <span class="keyword">command</span> <span class="built_in">line</span> <span class="keyword">options</span>.</div><div class="line">[<span class="number">2016</span>-<span class="number">09</span>-<span class="number">09</span>T14:<span class="number">40</span>:<span class="number">56</span>+<span class="number">08</span>:<span class="number">00</span>] WARN: No cookbooks directory found at <span class="built_in">or</span> above current directory.  Assuming C:/automate/chef</div><div class="line">-repo.</div><div class="line">Starting Chef Client, <span class="keyword">version</span> <span class="number">12.13</span>.<span class="number">37</span></div><div class="line">resolving cookbooks <span class="keyword">for</span> run lis<span class="variable">t:</span> []</div><div class="line">Synchronizing Cookbook<span class="variable">s:</span></div><div class="line">Installing Cookbook Gem<span class="variable">s:</span></div><div class="line">Compiling Cookbooks...</div><div class="line">[<span class="number">2016</span>-<span class="number">09</span>-<span class="number">09</span>T14:<span class="number">41</span>:<span class="number">09</span>+<span class="number">08</span>:<span class="number">00</span>] WARN: Node WIN-JQ088CD77EE <span class="built_in">has</span> <span class="keyword">an</span> <span class="built_in">empty</span> run <span class="keyword">list</span>.</div><div class="line">Converging <span class="number">3</span> resources</div><div class="line">Recipe: @recipe_file<span class="variable">s:</span>:C:/automate/chef-repo/webserver.rb</div><div class="line">  * powershell_script[Install IIS] action run (skipped due <span class="keyword">to</span> not_if)</div><div class="line">  * windows_service[w3svc] action enable (<span class="keyword">up</span> <span class="keyword">to</span> date)</div><div class="line">  * windows_service[w3svc] action start (<span class="keyword">up</span> <span class="keyword">to</span> date)</div><div class="line">  * <span class="keyword">file</span>[C:\inetpub\wwwroot\default.htm] action create</div><div class="line">    - create <span class="keyword">new</span> <span class="keyword">file</span> C:\inetpub\wwwroot\default.htm</div><div class="line">    - <span class="keyword">update</span> content in <span class="keyword">file</span> C:\inetpub\wwwroot\default.htm from none <span class="keyword">to</span> <span class="number">64538</span><span class="keyword">b</span></div><div class="line">    --- C:\inetpub\wwwroot\default.htm  <span class="number">2016</span>-<span class="number">09</span>-<span class="number">09</span> <span class="number">14</span>:<span class="number">41</span>:<span class="number">10.000000000</span> +<span class="number">0800</span></div><div class="line">    +++ C:\inetpub\wwwroot/chef-default.htm20160909-<span class="number">3184</span>-<span class="number">18</span>p9gz5        <span class="number">2016</span>-<span class="number">09</span>-<span class="number">09</span> <span class="number">14</span>:<span class="number">41</span>:<span class="number">10.000000000</span> +<span class="number">0800</span></div><div class="line">    @@ -<span class="number">1</span> +<span class="number">1</span>,<span class="number">6</span> @@</div><div class="line">    +<span class="symbol">&lt;html&gt;</span></div><div class="line">    +   <span class="symbol">&lt;body&gt;</span></div><div class="line">    +           <span class="symbol">&lt;h1&gt;</span>hello, chef.&lt;/h1&gt;</div><div class="line">    +   &lt;/body&gt;</div><div class="line">    +   &lt;/html&gt;</div><div class="line"></div><div class="line">Running handler<span class="variable">s:</span></div><div class="line">Running handlers <span class="built_in">complete</span></div><div class="line">Chef Client finished, <span class="number">1</span>/<span class="number">4</span> resources updated in <span class="number">13</span> seconds</div></pre></td></tr></table></figure></p>
<p>执行完成会创建<code>c:\inetpub\wwwroot\defualt.htm</code>文件。</p>
<h3 id="4-3-测试Web页面"><a href="#4-3-测试Web页面" class="headerlink" title="4.3 测试Web页面"></a>4.3 测试Web页面</h3><p>浏览器中访问default页面即可。</p>
<h2 id="5-Chef演练三：cookbook使用"><a href="#5-Chef演练三：cookbook使用" class="headerlink" title="5.Chef演练三：cookbook使用"></a>5.Chef演练三：cookbook使用</h2><h3 id="5-1-Cookbook概述"><a href="#5-1-Cookbook概述" class="headerlink" title="5.1 Cookbook概述"></a>5.1 Cookbook概述</h3><p>cookbook定义了一系列的部署任务，用于部署一套完整的用户环境。cookbook主要包括了以下几个组件：</p>
<ul>
<li><strong>Recipe：</strong> 用来定义对一个目标机器做部署的整个操作，比如，如何安装，安装哪些包，怎样做配置等。</li>
<li><strong>Attribute：</strong> 用来定义一个目标机器的属性值的。类似于定义一个全局变量，通常用来给 Cookbook 的其他组件提供属性值。</li>
<li><strong>File：</strong> 用来作部署的文件。一般会根据操作系统、平台等定义不同的文件配置。</li>
<li><strong>Library：</strong> 用来对 Cookbook 的功能做扩展。我们可以用 Ruby 语言编写自己的类来供 Recipe 调用。</li>
<li><strong>Resource：</strong> 用来自定义一个状态的运行规则。比如，针对服务的时候，我们可以定义几种不同的状态规则。</li>
<li><strong>Provider：</strong> 用来定义具体某个 Resource 的执行内容。从编程的角度可以理解为 Resource 定义了一个接口，而 Provider 是这个接口的实现。</li>
<li><strong>Template：</strong> 一些内嵌了 Ruby 标签的文件，通常用来定义配置文件。</li>
<li><strong>Metadata：</strong> 定义了 Cookbook 的属性值，比如，当前的 Cookbook 的版本，支持的平台，对其他 Cookbook 的依赖等信息。</li>
</ul>
<h3 id="5-2-创建cookbook"><a href="#5-2-创建cookbook" class="headerlink" title="5.2 创建cookbook"></a>5.2 创建cookbook</h3><p>先创建cookbooks文件夹：<code>mkdir cookbooks</code></p>
<p>执行chef命令创建cookbook：</p>
<p><code>chef generate cookbook cookbooks\learn_chef_iis</code></p>
<p>执行效果：<br><figure class="highlight vhdl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">PS C:\automate\chef-repo&gt; chef <span class="keyword">generate</span> cookbook cookbooks\learn_chef_iis</div><div class="line">Generating cookbook learn_chef_iis</div><div class="line">- Ensuring correct cookbook <span class="keyword">file</span> content</div><div class="line">- Ensuring delivery <span class="keyword">configuration</span></div><div class="line">- Ensuring correct delivery build cookbook content</div><div class="line"></div><div class="line">Your cookbook <span class="keyword">is</span> ready. <span class="keyword">Type</span> `cd cookbooks\learn_chef_iis` <span class="keyword">to</span> enter it.</div><div class="line"></div><div class="line">There are several commands you can run <span class="keyword">to</span> get started locally developing <span class="keyword">and</span> testing your cookbook.</div><div class="line"><span class="keyword">Type</span> `delivery local <span class="comment">--help` to see a full list.</span></div><div class="line"></div><div class="line">Why <span class="keyword">not</span> start by writing a test? Tests <span class="keyword">for</span> the <span class="keyword">default</span> recipe are stored at:</div><div class="line"></div><div class="line">test/recipes/default_test.rb</div><div class="line"></div><div class="line"><span class="keyword">If</span> you<span class="symbol">'d</span> prefer <span class="keyword">to</span> dive right <span class="keyword">in</span>, the <span class="keyword">default</span> recipe can be found at:</div><div class="line"></div><div class="line">recipes/<span class="keyword">default</span>.rb</div></pre></td></tr></table></figure></p>
<h3 id="5-3-创建template"><a href="#5-3-创建template" class="headerlink" title="5.3 创建template"></a>5.3 创建template</h3><p>将上节示例中的Web页面创建成template。</p>
<p>执行chef命令创建template：</p>
<p><code>chef generate template cookbooks\learn_chef_iis default.htm</code></p>
<p>执行效果：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">PS <span class="string">C:</span>\automate\chef-repo&gt; chef generate template cookbooks\learn_chef_iis <span class="keyword">default</span>.htm</div><div class="line"><span class="string">Recipe:</span> <span class="string">code_generator:</span>:template</div><div class="line">  * directory[cookbooks<span class="regexp">/learn_chef_iis/</span>templates/<span class="keyword">default</span>] action create</div><div class="line">    - create <span class="keyword">new</span> directory cookbooks<span class="regexp">/learn_chef_iis/</span>templates/<span class="keyword">default</span></div><div class="line">  * template[cookbooks<span class="regexp">/learn_chef_iis/</span>templates/<span class="keyword">default</span>.htm.erb] action create</div><div class="line">    - create <span class="keyword">new</span> file cookbooks<span class="regexp">/learn_chef_iis/</span>templates/<span class="keyword">default</span>.htm.erb</div><div class="line">    - update content <span class="keyword">in</span> file cookbooks<span class="regexp">/learn_chef_iis/</span>templates/<span class="keyword">default</span>.htm.erb from none to e3b0c4</div><div class="line">    (diff output suppressed by config)</div></pre></td></tr></table></figure></p>
<p>执行完成，会在<em>cookbooks/learn_chef_iis</em>下常见template文件夹，以及default.htm.erb文件。将页面内容复制到该文件中：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">h1</span>&gt;</span>hello, chef.<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h3 id="5-4-更新recipe内容"><a href="#5-4-更新recipe内容" class="headerlink" title="5.4 更新recipe内容"></a>5.4 更新recipe内容</h3><p>编辑recipe\default.rb文件：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">powershell_script <span class="string">'Install IIS'</span> <span class="keyword">do</span></div><div class="line">	code <span class="string">'Add-WindowsFeature Web-Server'</span></div><div class="line">	guard_interpreter <span class="symbol">:powershell_script</span></div><div class="line">	not_if <span class="string">"(Get-WindowsFeature -Name Web-Server).Installed"</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line">service <span class="string">'w3svc'</span> <span class="keyword">do</span></div><div class="line">	action [<span class="symbol">:enable</span>, <span class="symbol">:start</span>]</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line">template <span class="string">'c:\inetpub\wwwroot\index.htm'</span> <span class="keyword">do</span></div><div class="line">	source <span class="string">'default.htm.erb'</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p>
<h3 id="5-5-执行cookbook"><a href="#5-5-执行cookbook" class="headerlink" title="5.5 执行cookbook"></a>5.5 执行cookbook</h3><p>执行cookbook使用命令：</p>
<p><code>chef-client --local-mode --runlist &#39;recipe[learn_chef_iis]&#39;</code></p>
<p>执行效果：<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">PS C:\automate\chef-repo&gt; chef-client --local-<span class="keyword">mode</span> --runlist <span class="string">'recipe[learn_chef_iis]'</span></div><div class="line">[<span class="number">2016</span>-<span class="number">09</span>-<span class="number">09</span>T15:<span class="number">44</span>:<span class="number">50</span>+<span class="number">08</span>:<span class="number">00</span>] WARN: No config <span class="keyword">file</span> found <span class="built_in">or</span> specified <span class="keyword">on</span> <span class="keyword">command</span> <span class="built_in">line</span>, using <span class="keyword">command</span> <span class="built_in">line</span> <span class="keyword">options</span>.</div><div class="line">Starting Chef Client, <span class="keyword">version</span> <span class="number">12.13</span>.<span class="number">37</span></div><div class="line">resolving cookbooks <span class="keyword">for</span> run lis<span class="variable">t:</span> [<span class="string">"learn_chef_iis"</span>]</div><div class="line">Synchronizing Cookbook<span class="variable">s:</span></div><div class="line">  - learn_chef_iis (<span class="number">0.1</span>.<span class="number">0</span>)</div><div class="line">Installing Cookbook Gem<span class="variable">s:</span></div><div class="line">Compiling Cookbooks...</div><div class="line">Converging <span class="number">3</span> resources</div><div class="line">Recipe: learn_chef_ii<span class="variable">s:</span>:default</div><div class="line">  * powershell_script[Install IIS] action run (skipped due <span class="keyword">to</span> not_if)</div><div class="line">  * windows_service[w3svc] action enable (<span class="keyword">up</span> <span class="keyword">to</span> date)</div><div class="line">  * windows_service[w3svc] action start (<span class="keyword">up</span> <span class="keyword">to</span> date)</div><div class="line">  * template[<span class="keyword">c</span>:\inetpub\wwwroot\<span class="built_in">index</span>.htm] action create</div><div class="line">    - create <span class="keyword">new</span> <span class="keyword">file</span> <span class="keyword">c</span>:\inetpub\wwwroot\<span class="built_in">index</span>.htm</div><div class="line">    - <span class="keyword">update</span> content in <span class="keyword">file</span> <span class="keyword">c</span>:\inetpub\wwwroot\<span class="built_in">index</span>.htm from none <span class="keyword">to</span> c18cee</div><div class="line">    --- <span class="keyword">c</span>:\inetpub\wwwroot\<span class="built_in">index</span>.htm    <span class="number">2016</span>-<span class="number">09</span>-<span class="number">09</span> <span class="number">15</span>:<span class="number">45</span>:<span class="number">07.000000000</span> +<span class="number">0800</span></div><div class="line">    +++ <span class="keyword">c</span>:\inetpub\wwwroot/chef-<span class="built_in">index</span>.htm20160909-<span class="number">1312</span>-gj1hsq   <span class="number">2016</span>-<span class="number">09</span>-<span class="number">09</span> <span class="number">15</span>:<span class="number">45</span>:<span class="number">07.000000000</span> +<span class="number">0800</span></div><div class="line">    @@ -<span class="number">1</span> +<span class="number">1</span>,<span class="number">6</span> @@</div><div class="line">    +<span class="symbol">&lt;html&gt;</span></div><div class="line">    +   <span class="symbol">&lt;body&gt;</span></div><div class="line">    +           <span class="symbol">&lt;h1&gt;</span>hello, chef.&lt;/h1&gt;</div><div class="line">    +   &lt;/body&gt;</div><div class="line">    +&lt;/html&gt;</div><div class="line"></div><div class="line">Running handler<span class="variable">s:</span></div><div class="line">Running handlers <span class="built_in">complete</span></div><div class="line">Chef Client finished, <span class="number">1</span>/<span class="number">4</span> resources updated in <span class="number">16</span> seconds</div></pre></td></tr></table></figure></p>
<p>一个cookbook可以包含一个或多个recipe，可指定运行其中的一个，如：recipe[learn_chef_iis::default]。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p>[1] <a href="https://learn.chef.io/tutorials/learn-the-basics/windows/bring-your-own-system/" target="_blank" rel="external">Learn the Chef Basics</a></p>
<p>[2] <a href="http://www.ibm.com/developerworks/cn/cloud/library/1504_wangqw_chefcookbook/index.html" target="_blank" rel="external">Chef框架之Cookbook的介绍及应用</a></p>
<p>[3] <a href="http://www.cnblogs.com/shitoufengkuang/p/4825401.html" target="_blank" rel="external">使用Chef管理windows集群</a></p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://xinligis.github.io/2016/09/08/20160908-AGS10.4.x-ArcGIS自动化部署实践之一：Chef环境搭建与演练/" data-id="ciu3sfy7z0003t0v84fjxfb70" class="article-share-link">分享到</a><div class="tags"><a href="/tags/ArcGIS-Chef-自动化部署/">ArcGIS,Chef,自动化部署</a></div><div class="post-nav"><a href="/2016/10/09/20161009-AGS10.4.x-ArcGIS自动化部署实践之四：基于powershell的AGS Server自动部署1/" class="pre">ArcGIS自动化部署实践之四：基于PowerShell的AGS Server自动部署1</a><a href="/2016/09/08/20160909-AGS10.4.x-ArcGIS自动化部署实践之二：Chef生产环境测试/" class="next">ArcGIS自动化部署实践之二：Chef生产环境测试</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/地理平台/">地理平台</a><span class="category-list-count">5</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/10/09/20161009-AGS10.4.x-ArcGIS自动化部署实践之四：基于powershell的AGS Server自动部署1/">ArcGIS自动化部署实践之四：基于PowerShell的AGS Server自动部署1</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/08/20160908-AGS10.4.x-ArcGIS自动化部署实践之一：Chef环境搭建与演练/">ArcGIS自动化部署实践之一：Chef环境搭建与演练</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/08/20160909-AGS10.4.x-ArcGIS自动化部署实践之二：Chef生产环境测试/">ArcGIS自动化部署实践之二：Chef生产环境测试</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/08/20160919-AGS10.4.x-ArcGIS自动化部署实践之三：Powershell命令入门/">ArcGIS自动化部署实践之三：PowerShell命令入门</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/05/20160905-Portal10.4.x-部署常见问题处理/">Portal for ArcGIS部署常见问题处理</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://xinligis.github.io/" title="GitHub" target="_blank">GitHub</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">辛立.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
  });
</script><script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML" async></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>